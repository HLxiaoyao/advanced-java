# 如何避免缓存”雪崩”的问题？
由于缓存层承载着大量请求，有效的保护了存储层，但是如果缓存层由于某些原因整体不能提供服务，于是所有的请求都会达到存储层，存储层的调用量会暴增，造成存储层也会挂掉的情况。缓存雪崩的英文原意是 stampeding herd（奔逃的野牛），指的是缓存层宕掉后，流量会像奔逃的野牛一样，打向后端存储。

![](/images/redis/缓存雪崩.png)

预防和解决缓存雪崩问题，可以从以下三个方面进行着手。
## 保证缓存层服务高可用性
在缓存雪崩发生之前，做好预防手段，防止雪崩的放生。使用缓存集群，保证缓存高可用。这样即使个别节点、个别机器、甚至是机房宕掉，依然可以提供服务，例如Redis Sentinel和Redis Cluster都实现了高可用。

## 本地缓存
如果使用本地缓存时，即使分布式缓存挂了，也可以将DB查询到的结果缓存到本地，避免后续请求全部到达DB中。当然，引入本地缓存也会有相应的问题，例如说：
    
    （1）本地缓存的实时性怎么保证？
            方案一，可以引入消息队列。在数据更新时，发布数据更新的消息；而进程中有相应的消费者消费该消息，从而更新本地缓存。
            方案二，设置较短的过期时间，请求时从DB重新拉取。
            方案三，手动过期，详细见如何避免缓存”击穿”的问题？

    （2）每个进程可能会本地缓存相同的数据，导致数据浪费？
            方案一，需要配置本地缓存的过期策略和缓存数量上限。

## 依赖隔离组件为后端限流并降级
无论是缓存层还是存储层都会有出错的概率，可以将它们视同为资源。作为并发量较大的系统，假如有一个资源不可用，可能会造成所有线程在获取这个资源时异常，造成整个系统不可用。降级在高并发系统中是非常正常的，比如推荐服务中，如果个性化推荐服务不可用，可以降级补充热点数据，不至于造成前端页面是开天窗。

在实际项目中，需要对重要的资源(例如Redis、MySQL、Hbase、外部接口)都进行隔离，让每种资源都单独运行在自己的线程池中，即使个别资源出现了问题，对其他服务没有影响。但是线程池如何管理，比如如何关闭资源池，开启资源池，资源池阀值管理，这些做起来还是相当复杂的，这里推荐一个Java依赖隔离工具。

Hystrix就是一个Java类库，它采用命令模式，每一项服务处理请求都有各自的处理器。所有的请求都要经过各自的处理器。处理器会记录当前服务的请求失败率。一旦发现当前服务的请求失败率达到预设的值，Hystrix将会拒绝随后该服务的所有请求，直接返回一个预设的结果。这就是所谓的“熔断”。当经过一段时间后，Hystrix会放行该服务的一部分请求，再次统计它的请求失败率。如果此时请求失败率符合预设值，则完全打开限流开关；如果请求失败率仍然很高，那么继续拒绝该服务的所有请求。这就是所谓的“限流”。而Hystrix向那些被拒绝的请求直接返回一个预设结果，被称为“降级”。

除此之外也可以在DB层面进行限流，通过限制DB的每秒请求数，避免把DB也打挂了。这样至少能有两个好处：

    （1）可能有一部分用户，还可以使用，系统还没死透。
    （2）未来缓存服务恢复后，系统立即就已经恢复，无需再处理DB也挂掉的情况。


